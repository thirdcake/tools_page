<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>囲碁部分図</title>
    <style>
        html,body {margin:0;padding:0;color:#111;font-size:18px;}
        * {margin:0;padding:0;box-sizing:border-box;}
        h1 {margin:0;padding:.5rem;font-weight:normal;font-size:1rem;}
        ul, li {list-style-type: none;}
        ul.list {margin:0; padding:.5rem 1rem;display:flex;flex-wrap:wrap;gap:.5rem 1rem;}
        li > label {margin:0;padding:0 .5rem;border:thin solid #333;border-radius:.3rem;}
        li > label:has(input[type="radio"]:checked){color:#8f8;background-color: #555;}
        button {display:block;padding:0 .5rem;border:thin solid #333;border-radius:.3rem;background-color:transparent;}
        button:hover {background-color:#eee;}
        button:active {background-color:#aaa;}
        svg {cursor:pointer;}
        .display-flex {display:flex;align-items:flex-start;justify-content:flex-start;gap:0;}
        .display-flex > label {padding:.8rem;cursor:pointer;}
        .display-flex > label:hover {background-color:#ccc;}
        .display-flex > label > span {display:block;width:100%;}
        .display-flex > label > span[data-t="textarea"] {white-space:pre-wrap;}
        .display-flex > label > span > svg {display:block;width:100%;height:auto;}
        span[data-t="textarea"] {font-size:20px;}
        textarea {font-size:20px;}
        @media print {
            .no-print {display:none !important;}
            .display-flex {justify-content:space-between;height:32vh;gap:1rem;}
            .display-flex > label {padding:0;flex:1 1 50vw;}
            .display-flex > label > span {display:block;height:100%;}
            .display-flex > label > span > svg {display:block;width:auto;height:6.5cm;}
        }
    </style>
</head>
<body>
    <h1 class="no-print">囲碁全体図 問題解答 印刷用</h1>
    <ul class="list no-print">
        <li><label><input type="radio" value="0" name="tab" checked />全体を俯瞰</label></li>
        <li><label><input id="tab-1" type="radio" value="1" name="tab" />左上を拡大</label></li>
        <li><label><input id="tab-2" type="radio" value="2" name="tab" />右上を拡大</label></li>
        <li><label><input id="tab-3" type="radio" value="3" name="tab" />左中を拡大</label></li>
        <li><label><input id="tab-4" type="radio" value="4" name="tab" />右中を拡大</label></li>
        <li><label><input id="tab-5" type="radio" value="5" name="tab" />左下を拡大</label></li>
        <li><label><input id="tab-6" type="radio" value="6" name="tab" />右下を拡大</label></li>
    </ul>
    <div id="display">
        <ul class="list no-print">
            <li><button type="button" value="save" id="save">保存</button></li>
            <li>読込: <input type="file" id="load" accept="application/json"></li>
        </ul>
        <div class="display-flex">
            <label for="tab-1"><span data-v="1"></span><span data-t="textarea"></span></label>
            <label for="tab-2"><span data-v="2"></span><span data-t="textarea"></span></label>
        </div>
        <div class="display-flex">
            <label for="tab-3"><span data-v="3"></span><span data-t="textarea"></span></label>
            <label for="tab-4"><span data-v="4"></span><span data-t="textarea"></span></label>
        </div>
        <div class="display-flex">
            <label for="tab-5"><span data-v="5"></span><span data-t="textarea"></span></label>
            <label for="tab-6"><span data-v="6"></span><span data-t="textarea"></span></label>
        </div>
    </div>
    <div id="input">
        <ul class="list">
            <li>碁石の色：</li>
            <li><label><input type="radio" value="0" name="color" checked />無色</label></li>
            <li><label><input type="radio" value="1" name="color" />黒</label></li>
            <li><label><input type="radio" value="2" name="color" />白</label></li>
        </ul>
        <ul class="list">
            <li>文字：</li>
            <li><label><input type="radio" value="0" name="char" checked />（無し）</label></li>
            <li><label><input type="radio" value="A" name="char" />A</label></li>
            <li><label><input type="radio" value="B" name="char" />B</label></li>
            <li><label><input type="radio" value="C" name="char" />C</label></li>
            <li><label><input type="radio" value="D" name="char" />D</label></li>
            <li><label><input type="radio" value="E" name="char" />E</label></li>
            <li><label><input type="radio" value="△" name="char" />△</label></li>
            <li><label><input type="radio" value="1" name="char" />1</label></li>
            <li><label><input type="radio" value="2" name="char" />2</label></li>
            <li><label><input type="radio" value="3" name="char" />3</label></li>
            <li><label><input type="radio" value="4" name="char" />4</label></li>
            <li><label><input type="radio" value="5" name="char" />5</label></li>
        </ul>
        <div class="svg-input" style="max-width: 600px;"></div>
        <div style="padding:1rem;">
            <textarea placeholder="ここに文章を書けます。" id="textarea" aria-label="文章追加部"
                style="margin:0;padding:.5rem;width:100%;max-width:600px;height:5rem;"></textarea>
        </div>
    </div>
    <script>
        'use strict';
        document.addEventListener('DOMContentLoaded', igo, false);
        function igo () {
            let state = init();
            render(state);
            document.addEventListener('click', (ev) => {
                const label = ev.target.closest('label');
                if(label !== null) return;
                state = handleClick(ev, state);
            }, false);
            document.addEventListener('change', async (ev) => {
                const file = ev.target.files;
                if (!!file) {
                    state = await load(ev, state);
                }else{
                    state = handleRadio(ev, state);
                }
            }, false);
        }

        function resetRadio() {
            document.getElementsByName('tab')[0].click();
            document.getElementsByName('color')[0].click();
            document.getElementsByName('char')[0].click();
        }

        function init () {
            resetRadio();
            const tab = Number(document.querySelector('input[name="tab"]:checked').value);
            const svgs = Array.from({length: 6}, (_, i) => new IgoSvg(i+1) );
            const textarea = new Array(6).fill('');
            return {
                tab,
                svgs,
                textarea,
                color: 0,
                char: 0,
            }
        }
        
        function handleClick (ev, state) {
            const svg = ev.target.closest('svg');
            if(svg !== null) {
                if(state.tab===0) {
                    // これ不要かも？
                    state.tab = Number(svg.parentNode.dataset.v);
                }else{
                    const instance = state.svgs[state.tab-1];
                    instance.onClick(ev, state);
                }
                render(state);
            }
            const button = ev.target.closest('button');
            if(button !== null && button.value==='save') {
                if(window.confirm('保存してよろしいですか？')) {
                    save(state);
                }
            }
            return state;
        }

        function handleRadio (ev, state) {
            switch(ev.target.name) {
                case 'tab':
                    if(state.tab > 0) {
                        state.textarea[state.tab-1] = document.querySelector('textarea#textarea').value;
                    }
                    state.tab = Number(ev.target.value);
                    if(state.tab > 0) {
                        document.querySelector('textarea#textarea').value = state.textarea[state.tab-1];
                    }
                    render(state);
                    break;
                case 'color':
                    state.color = Number(ev.target.value);
                    break;
                case 'char':
                    let char = ev.target.value;
                    char = char[0];
                    char = isNaN(parseInt(char)) ? char : Number(char);
                    state.char = char;
                    break;
            }
            return state;
        }

        function render(state) {
            const display = document.querySelector('#display');
            const input = document.querySelector('#input');
            if(state.tab===0) {
                input.style.display = 'none';
                display.style.display = 'block';
                state.svgs.forEach((svg, i) => {
                    display.querySelector(`span[data-v="${i+1}"]`).appendChild(svg.svg);
                });
                state.textarea.forEach((text, i) => {
                    display.querySelector(`span[data-v="${i+1}"]~span[data-t="textarea"]`).textContent = text;
                });
            }else{
                display.style.display = 'none';
                input.style.display = 'block';
                const tab = state.tab;
                const svgInput = input.querySelector('div.svg-input');
                while(!!svgInput.lastChild) {
                    svgInput.removeChild(svgInput.lastChild);
                }
                svgInput.appendChild(state.svgs[tab-1].svg);
            }
        }

        function save(state) {
            const json = JSON.stringify({
                data: state.svgs.map(igosvg => igosvg.data),
                textarea: state.textarea,
            });
            const blob = new Blob([json], { type: "application/json" });  // Blob 作成
            const url = URL.createObjectURL(blob);  // ダウンロード用のURLを生成
            // 一時的に a タグを作ってクリックしてダウンロード
            const a = document.createElement("a");
            a.href = url;
            a.download = `囲碁データ${Date.now()}.json`; // ダウンロードするファイル名
            a.click();
            URL.revokeObjectURL(url);  // メモリ解放
        }

        async function load(ev, state) {
            const file = ev.target.files[0];
            try {
                const jsonText = await file.text();  // ファイル内容（文字列）
                const data = JSON.parse(jsonText);
                data.data.forEach((dat, i) => {state.svgs[i].setData(dat)});
                state.svgs.forEach(svg => {svg.render()});
                data.textarea.forEach((textarea, i) => {
                    if(typeof textarea === 'string') {
                        state.textarea[i] = textarea;
                    }
                });
                resetRadio();
                render(state);
            } catch (err) {
                console.error("JSONのパースに失敗:", err);
            }
            return state;
        }

        class IgoSvg {
            ns = 'http://www.w3.org/2000/svg';
            svg;
            thin = 2;
            thick = 4;
            square_width = 48;
            radius = 20;
            grid;
            data;
            group;
            constructor(id) {
                const margin = Math.floor(this.square_width / 2);
                const pitch = (_, i) => margin + this.square_width * i;
                const row_positions = Array.from({length: 9}, pitch);
                const col_positions = Array.from({length: 11}, pitch);
                this.grid = this.createGrid(row_positions, col_positions);
                this.svg = this.createSvg(id, row_positions, col_positions);
                this.group = document.createElementNS(this.ns, 'g');
                this.svg.appendChild(this.group);
                this.data = Array.from({length: 11*9}, () => [0, 0]);
            }

            createGrid(row_positions, col_positions) {
                const grid = [];
                row_positions.forEach(y => {
                    col_positions.forEach(x => {
                        grid.push([x, y]);
                    })
                });
                return grid;
            }

            createSvg(id, row_positions, col_positions) {
                const svg = document.createElementNS(this.ns, 'svg');
                const w = this.square_width * 11;
                const h = this.square_width * 9;
                svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
                // line を作る
                const createLine = (x1, x2, y1, y2, s_w) => {
                    const line = document.createElementNS(this.ns, 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y1', y1);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', '#333');
                    line.setAttribute('stroke-width', s_w);
                    return line;
                }
                const margin = Math.floor(this.square_width / 2);
                const row_start = margin - Math.floor(this.thick / 2),
                    col_end = h - row_start;
                row_positions.forEach((x, i) => {
                    const lx = (i===8)
                        ? createLine(row_start, w, x, x, this.thick)
                        : createLine(row_start, w, x, x, this.thin);
                    svg.appendChild(lx);
                });
                col_positions.forEach((y, i) => {
                    const ly = (i===0)
                        ? createLine(y, y, 0, col_end, this.thick)
                        : createLine(y, y, 0, col_end, this.thin);
                    svg.appendChild(ly);
                });
                // dot を作る
                const createDot = (cy, cx) => {
                    const dot = document.createElementNS(this.ns, 'circle');
                    dot.setAttribute('cx', cx);
                    dot.setAttribute('cy', cy);
                    dot.setAttribute('r', Math.floor(this.thick * 1.5));
                    dot.setAttribute('fill', '#333');
                    return dot;
                }
                svg.appendChild(createDot(row_positions[5], col_positions[3]));
                svg.appendChild(createDot(row_positions[5], col_positions[9]));
                return svg;
            }
            onClick(ev, state) {
                const index = this.nearestIndex(ev.clientX, ev.clientY);
                // const [cx, cy] = this.grid[index];
                if(this.data[index][0] === state.color
                    && this.data[index][1] === state.char) {
                        this.data[index] = [0, 0];
                }else{
                    this.data[index] = [state.color, state.char];
                }
                this.render();
            }
            nearestIndex(clientX, clientY) {
                const pt = this.svg.createSVGPoint();
                pt.x = clientX;
                pt.y = clientY;
                const p = pt.matrixTransform(this.svg.getScreenCTM().inverse());
                const index = this.grid
                .map(([x, y]) => (p.x-x)**2 + (p.y-y)**2)
                .reduce(([minDist, idx], dist, i) => {
                    return (minDist <= dist) ? [minDist, idx] : [dist, i]
                }, [1<<30, -1])
                .at(1);
                return index;
            }
            clear() {
                while(!!this.group.lastChild) {
                    this.group.removeChild(this.group.lastChild);
                }
            }
            render() {
                this.clear();
                this.data.forEach(([color, char], i) => {
                    if(color===0 && char===0) return;
                    const [cx, cy] = this.grid[i];
                    const stone = this.createStone(cx, cy, color, char);
                    this.group.appendChild(stone);
                });
            }

            createStone(cx, cy, color, char) {
                const stone = document.createElementNS(this.ns, 'g');
                const circle = document.createElementNS(this.ns, 'circle');
                circle.setAttribute('cx', cx);
                circle.setAttribute('cy', cy);
                circle.setAttribute('r', this.radius);
                const fill = (color===1) ? '#333' : '#fff';
                const stroke = (color===0) ? '#fff' : '#333';
                circle.setAttribute('fill', fill); 
                circle.setAttribute('stroke', stroke);
                circle.setAttribute('stroke-width', 4);
                stone.appendChild(circle);
                if(char!==0) {
                    const text = document.createElementNS(this.ns, 'text');
                    text.setAttribute('style', `font: normal ${this.radius*1.8}px sans-serif`);
                    text.setAttribute('x', cx);
                    text.setAttribute('y', cy+(this.radius*.6));
                    const text_fill = (color===1) ? '#fff' : '#333';
                    text.setAttribute('fill', text_fill);
                    text.setAttribute('text-anchor', 'middle');
                    text.textContent = char;
                    stone.appendChild(text);
                }
                return stone;
            }
            setData(data) {
                if(Array.isArray(data)===false) {
                    console.error('データがおかしいです');
                    return;
                }
                if(data.length !== 11*9) {
                    console.error('data の要素数エラー');
                    return;
                }
                data.forEach((dat, i) => {
                    if(Array.isArray(dat)===false) return;
                    if(dat.length !== 2) return;
                    if([0,1,2].includes(dat[0])===false) return;
                    if(['string', 'number'].includes(typeof dat[1])===false) return;
                    this.data[i] = dat;
                });
            }
        }
    </script>
</body>
</html>
